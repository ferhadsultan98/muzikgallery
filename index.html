m<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmony Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* General Resets and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative; /* For animated background */
        }

        body::before { /* Animated Background */
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(45deg, #ff007f, #00ffc3, #007bff, #ff0000, #ffff00, #ff7f00, #7f00ff, #00ffff, #ff00ff, #3333ff);
            background-size: 400% 400%;
            animation: gradientAnimation 30s ease infinite;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        button {
            cursor: pointer;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: bold;
        }

        button:hover {
            background-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background-color: rgba(0, 0, 0, 0.3);
            color: #fff;
        }
        input[type="file"] {
            margin-bottom: 15px;
            color: #fff;
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .flexCenter { display: flex; justify-content: center; align-items: center; }

        /* Auth Screen (Banner, Login/Register Buttons) */
        .authScreen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            background-color: rgba(0,0,0,0.3); /* Slight dimming for banner text visibility */
        }
        .authScreen h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .authScreen p {
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        .authButtons button {
            margin: 0 10px;
            padding: 12px 25px;
            font-size: 1.1rem;
        }

        /* Auth Forms (Login/Register) */
        .formContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            z-index: 1000;
        }
        .formContainer.active {
            opacity: 1;
            visibility: visible;
        }
        .authForm {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .authForm h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        .authForm .closeButton {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            font-size: 1.5rem;
            color: #fff;
        }

        /* Main Application Wrapper */
        .appWrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding-top: 70px; /* Space for fixed header */
        }

        /* Header (Desktop and Mobile Top) */
        .appHeader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 900;
        }
        .profileIconContainer img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.5);
        }

        /* Desktop Navbar */
        .desktopNavbar {
            display: none; /* Hidden by default, shown on desktop */
        }
        .desktopNavbar ul {
            list-style: none;
            display: flex;
        }
        .desktopNavbar li {
            margin-left: 20px;
        }
        .desktopNavbar a {
            text-decoration: none;
            color: #fff;
            font-weight: bold;
            padding: 10px;
            transition: color 0.3s ease;
        }
        .desktopNavbar a:hover, .desktopNavbar a.active {
            color: #00ffc3;
        }

        /* Mobile Bottom Navbar & Hamburger */
        .mobileHamburgerButton {
            display: block; /* Shown by default, hidden on desktop */
            font-size: 1.5rem;
            background: none;
            color: #fff;
            padding: 5px;
        }
        .mobileBottomNavbar {
            display: none; /* Hidden by default, shown on mobile */
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 900;
        }
        .mobileBottomNavbar.active { /* This is for the menu itself, not the bar */
             /* Styles for the opened menu - if it's a separate element */
        }
        .mobileNavMenu {
            position: fixed;
            left: -100%; /* Start off-screen */
            top: 0;
            width: 70%;
            max-width: 280px;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            padding-top: 70px; /* Align with header */
            transition: left 0.3s ease-in-out;
            z-index: 890; /* Below header */
        }
        .mobileNavMenu.open {
            left: 0;
        }
        .mobileNavMenu ul {
            list-style: none;
            padding: 20px;
        }
        .mobileNavMenu li a {
            display: block;
            padding: 15px;
            color: #fff;
            text-decoration: none;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .mobileNavMenu li a:hover, .mobileNavMenu li a.active {
            background-color: rgba(255,255,255,0.1);
            color: #00ffc3;
        }


        /* Profile Modal */
        .profileModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            z-index: 1000;
        }
        .profileModal.active {
            opacity: 1;
            visibility: visible;
        }
        .profileModalContent {
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }
        .profileModalContent h2 {
            margin-bottom: 20px;
        }
        .profileModalContent .closeButton {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            font-size: 1.5rem;
            color: #fff;
        }
        .profileModalContent img.profilePreview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 15px;
            display: block;
            object-fit: cover;
        }

        /* Content Sections */
        .contentSection {
            flex-grow: 1;
            padding: 20px;
            display: none; /* Hidden by default, shown by JS */
        }
        .contentSection.active {
            display: block;
        }
        .contentSection h2 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
        }

        /* Home View - Music Player */
        .musicPlayerContainer {
            background-color: rgba(0,0,0,0.4);
            padding: 20px;
            border-radius: 10px;
            max-width: 450px;
            margin: 20px auto;
            text-align: center;
        }
        .musicCover {
            width: 100%;
            max-width: 300px;
            height: auto;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .musicInfo h3 { /* Music Name */
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        .musicInfo p { /* Artist Name */
            font-size: 1rem;
            color: #ccc;
            margin-bottom: 15px;
        }
        .musicProgress {
            width: 100%;
            height: 8px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
            overflow: hidden;
        }
        .musicProgressBar {
            width: 0%;
            height: 100%;
            background-color: #00ffc3;
            border-radius: 4px;
            transition: width 0.1s linear; /* Smooth progress */
        }
        .timeDisplay {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #bbb;
            margin-bottom: 20px;
        }
        .musicControls {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .musicControls button {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.8rem;
            margin: 0 15px;
            padding: 10px;
        }
        .musicControls .playPauseButton {
            font-size: 2.5rem; /* Larger play/pause */
        }
        .musicControls button:hover {
            color: #00ffc3;
            transform: scale(1.1);
        }

        .noMusicMessage {
            text-align: center;
            padding: 50px 20px;
            animation: fadeInPulse 2s infinite alternate;
        }
        .noMusicMessage i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #00ffc3;
        }
        @keyframes fadeInPulse {
            from { opacity: 0.7; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1.02); }
        }

        /* Music List (below player or in playlists) */
        .musicList {
            margin-top: 30px;
        }
        .musicListItem {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .musicListItem:hover, .musicListItem.playing {
            background-color: rgba(0, 255, 195, 0.1);
        }
        .musicListItem img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 15px;
        }
        .musicListItemInfo h4 { font-size: 1rem; }
        .musicListItemInfo p { font-size: 0.8rem; color: #ccc; }

        /* Music Add View */
        .musicAddForm label {
            display: block;
            margin-bottom: 5px;
            color: #ddd;
        }

        /* Playlists View */
        .playlistGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .playlistItem {
            background-color: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .playlistItem:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 255, 195, 0.2);
        }
        .playlistItem i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #00ffc3;
        }
        .createPlaylistButton {
            display: block;
            margin: 20px auto;
            width: fit-content;
        }

        /* Search View */
        .searchContainer {
            display: flex;
            margin-bottom: 20px;
        }
        .searchContainer input {
            flex-grow: 1;
            margin-bottom: 0;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .searchContainer button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            background-color: #00ffc3;
            color: #111;
        }
        .searchResults {
            /* Uses .musicList and .musicListItem styles */
        }


        /* Responsive Design */

        /* Mobile First - styles above are predominantly mobile-friendly */

        /* Desktop Styles (min-width: 769px) */
        @media (min-width: 769px) {
            .authScreen h1 { font-size: 4rem; }
            .authForm { padding: 40px; }

            .appWrapper {
                flex-direction: row; /* Sidebar and content side-by-side potentially, or just header */
                padding-top: 70px; /* Header height */
                padding-left: 0; /* Reset if a fixed sidebar was planned */
            }

            .desktopNavbar {
                display: flex; /* Show desktop navbar */
            }
            .mobileHamburgerButton {
                display: none; /* Hide hamburger on desktop */
            }
            .mobileBottomNavbar {
                display: none; /* Hide mobile bottom bar */
            }
             .mobileNavMenu {
                display: none; /* Ensure mobile slide-out menu is hidden */
            }

            .contentSection {
                padding: 30px 40px; /* More padding on desktop */
            }
            .contentSection h2 {
                 text-align: left; /* Align section titles to left on desktop */
            }

            .musicPlayerContainer {
                /* Maybe center it on a wider page or integrate differently */
                 margin: 30px auto; /* Can remain centered */
            }

            .playlistGrid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); /* Larger playlist items */
            }
        }

        /* Specific adjustments for smaller mobiles if needed */
        @media (max-width: 480px) {
            .authScreen h1 { font-size: 2.5rem; }
            .authButtons button { padding: 10px 20px; font-size: 1rem; }
            .musicControls button { margin: 0 10px; font-size: 1.5rem; }
            .musicControls .playPauseButton { font-size: 2rem; }
        }

    </style>
</head>
<body>

    <div id="authScreen" class="authScreen">
        <h1>Welcome to Harmony Hub</h1>
        <p>Your personal music universe. Login or Register to dive in.</p>
        <div class="authButtons">
            <button id="showLoginButton">Login</button>
            <button id="showRegisterButton">Register</button>
        </div>
    </div>

    <div id="loginFormContainer" class="formContainer">
        <form id="loginForm" class="authForm">
            <button type="button" class="closeButton" data-target-form="loginFormContainer">&times;</button>
            <h2>Login</h2>
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button type="submit">Login</button>
            <p id="loginError" style="color: red; margin-top: 10px; text-align:center;"></p>
        </form>
    </div>

    <div id="registerFormContainer" class="formContainer">
        <form id="registerForm" class="authForm">
            <button type="button" class="closeButton" data-target-form="registerFormContainer">&times;</button>
            <h2>Register</h2>
            <input type="text" id="registerFullName" placeholder="Full Name" required>
            <input type="text" id="registerUsername" placeholder="Username" required>
            <input type="email" id="registerEmail" placeholder="Email" required>
            <input type="password" id="registerPassword" placeholder="Password (min. 6 chars)" required>
            <label for="registerGender">Gender:</label>
            <select id="registerGender" required>
                <option value="">Select Gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
                <option value="prefer_not_to_say">Prefer not to say</option>
            </select>
            <label for="registerDob">Date of Birth:</label>
            <input type="date" id="registerDob" required>
            <label for="registerProfilePic">Profile Picture (Optional):</label>
            <input type="file" id="registerProfilePic" accept="image/*">
            <button type="submit">Register</button>
            <p id="registerError" style="color: red; margin-top: 10px; text-align:center;"></p>
        </form>
    </div>


    <div id="appWrapper" class="appWrapper hidden">
        <header class="appHeader">
            <div class="profileIconContainer">
                <img id="headerProfilePic" src="https://via.placeholder.com/40" alt="Profile">
            </div>
            <nav class="desktopNavbar">
                <ul>
                    <li><a href="#" class="navLink active" data-section="homeSection">Home</a></li>
                    <li><a href="#" class="navLink" data-section="musicAddSection">Add Music</a></li>
                    <li><a href="#" class="navLink" data-section="searchSection">Search</a></li>
                    <li><a href="#" class="navLink" data-section="playlistsSection">Playlists</a></li>
                    <li><a href="#" id="logoutButton">Logout</a></li>
                </ul>
            </nav>
            <button class="mobileHamburgerButton" id="mobileHamburgerButton">
                <i class="fas fa-bars"></i>
            </button>
        </header>

        <nav class="mobileNavMenu" id="mobileNavMenu">
            <ul>
                 <li><a href="#" class="navLink active" data-section="homeSection">Home</a></li>
                 <li><a href="#" class="navLink" data-section="musicAddSection">Add Music</a></li>
                 <li><a href="#" class="navLink" data-section="searchSection">Search</a></li>
                 <li><a href="#" class="navLink" data-section="playlistsSection">Playlists</a></li>
                 <li><a href="#" id="mobileLogoutButton">Logout</a></li>
            </ul>
        </nav>


        <main id="mainContent">
            <section id="homeSection" class="contentSection active">
                <div id="homeMusicContent">
                    </div>
            </section>

            <section id="musicAddSection" class="contentSection">
                <h2>Add New Music</h2>
                <form id="musicAddForm" class="musicAddForm">
                    <label for="musicName">Music Title:</label>
                    <input type="text" id="musicName" required>

                    <label for="musicArtist">Artist Name:</label>
                    <input type="text" id="musicArtist">

                    <label for="musicFileUrl">Music Audio URL:</label>
                    <input type="text" id="musicFileUrl" placeholder="Enter direct URL to audio file" required>
                    <label for="musicCoverImage">Cover Image:</label>
                    <input type="file" id="musicCoverImage" accept="image/*" required>
                    <img id="musicCoverPreview" src="#" alt="Cover Preview" style="max-width: 100px; display: none; margin-top:10px;">


                    <label for="musicPlaylist">Add to Playlist:</label>
                    <select id="musicPlaylist">
                        <option value="">Select Playlist</option>
                        </select>
                    <input type="text" id="newPlaylistName" placeholder="Or, type new playlist name">

                    <button type="submit">Add Music</button>
                    <p id="musicAddError" style="color: red; margin-top: 10px;"></p>
                    <p id="musicAddSuccess" style="color: lightgreen; margin-top: 10px;"></p>
                </form>
            </section>

            <section id="searchSection" class="contentSection">
                <h2>Search Music</h2>
                <div class="searchContainer">
                    <input type="text" id="searchInput" placeholder="Search for songs, artists...">
                    <button id="searchButton"><i class="fas fa-search"></i></button>
                </div>
                <div id="searchResults" class="musicList">
                    <p>Start typing to search for music across all users.</p>
                </div>
            </section>

            <section id="playlistsSection" class="contentSection">
                <h2>Your Playlists</h2>
                <button id="showCreatePlaylistFormButton" class="createPlaylistButton"><i class="fas fa-plus-circle"></i> Create New Playlist</button>
                <form id="createPlaylistForm" class="hidden" style="margin-bottom:20px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 5px;">
                    <input type="text" id="newPlaylistTitle" placeholder="New Playlist Title" required>
                    <button type="submit">Create Playlist</button>
                </form>
                <div id="playlistGrid" class="playlistGrid">
                    <p id="noPlaylistsMessage">You don't have any playlists yet. Create one!</p>
                </div>
            </section>
        </main>

        </div> <div id="profileModal" class="profileModal">
        <div class="profileModalContent">
            <button type="button" class="closeButton" data-target-form="profileModal">&times;</button>
            <h2>Edit Profile</h2>
            <form id="profileEditForm">
                <img id="profileModalPreview" src="https://via.placeholder.com/100" alt="Profile Preview" class="profilePreview">
                <label for="profileEditFullName">Full Name:</label>
                <input type="text" id="profileEditFullName" required>
                <label for="profileEditUsername">Username:</label>
                <input type="text" id="profileEditUsername" required>
                <label for="profileEditGender">Gender:</label>
                <select id="profileEditGender" required>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                    <option value="prefer_not_to_say">Prefer not to say</option>
                </select>
                <label for="profileEditDob">Date of Birth:</label>
                <input type="date" id="profileEditDob" required>
                <label for="profileEditProfilePic">New Profile Picture (Optional):</label>
                <input type="file" id="profileEditProfilePic" accept="image/*">
                <button type="submit">Save Changes</button>
                <p id="profileEditError" style="color: red; margin-top: 10px;"></p>
                <p id="profileEditSuccess" style="color: lightgreen; margin-top: 10px;"></p>
            </form>
        </div>
    </div>

    <audio id="audioPlayer"></audio>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getDatabase,
            ref,
            set,
            get,
            child,
            push,
            update,
            query,
            orderByChild,
            equalTo,
            onValue
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDJVgACPnByrvJBrrpSqPbyjztKIYLCMg0", // REPLACE WITH YOURS
            authDomain: "react-c2da8.firebaseapp.com",       // REPLACE WITH YOURS
            databaseURL: "https://react-c2da8-default-rtdb.firebaseio.com", // REPLACE WITH YOURS
            projectId: "react-c2da8",                       // REPLACE WITH YOURS
            storageBucket: "react-c2da8.firebasestorage.app", // REPLACE WITH YOURS
            messagingSenderId: "700327720805",              // REPLACE WITH YOURS
            appId: "1:700327720805:web:bbe2cf35b08d3f5d04538c", // REPLACE WITH YOURS
            measurementId: "G-2PKHCWP06M"                   // REPLACE WITH YOURS (Optional)
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); // Optional
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Cloudinary Configuration
        const cloudinaryCloudName = "dbiltdpxh"; // REPLACE WITH YOUR CLOUD NAME
        const cloudinaryPreset = "farhadsultan";  // REPLACE WITH YOUR UNSIGNED UPLOAD PRESET

        // DOM Elements
        const authScreen = document.getElementById('authScreen');
        const appWrapper = document.getElementById('appWrapper');
        const mainContent = document.getElementById('mainContent');

        const showLoginButton = document.getElementById('showLoginButton');
        const showRegisterButton = document.getElementById('showRegisterButton');
        const loginFormContainer = document.getElementById('loginFormContainer');
        const registerFormContainer = document.getElementById('registerFormContainer');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');

        const headerProfilePic = document.getElementById('headerProfilePic');
        const profileModal = document.getElementById('profileModal');
        const profileEditForm = document.getElementById('profileEditForm');
        const profileModalPreview = document.getElementById('profileModalPreview');
        const profileEditFullName = document.getElementById('profileEditFullName');
        const profileEditUsername = document.getElementById('profileEditUsername');
        const profileEditGender = document.getElementById('profileEditGender');
        const profileEditDob = document.getElementById('profileEditDob');
        const profileEditError = document.getElementById('profileEditError');
        const profileEditSuccess = document.getElementById('profileEditSuccess');


        const logoutButton = document.getElementById('logoutButton');
        const mobileLogoutButton = document.getElementById('mobileLogoutButton');
        const mobileHamburgerButton = document.getElementById('mobileHamburgerButton');
        const mobileNavMenu = document.getElementById('mobileNavMenu');

        const navLinks = document.querySelectorAll('.navLink');
        const contentSections = document.querySelectorAll('.contentSection');

        const homeMusicContent = document.getElementById('homeMusicContent');
        const audioPlayer = document.getElementById('audioPlayer');

        const musicAddForm = document.getElementById('musicAddForm');
        const musicNameInput = document.getElementById('musicName');
        const musicArtistInput = document.getElementById('musicArtist');
        const musicFileUrlInput = document.getElementById('musicFileUrl');
        const musicCoverImageInput = document.getElementById('musicCoverImage');
        const musicCoverPreview = document.getElementById('musicCoverPreview');
        const musicPlaylistSelect = document.getElementById('musicPlaylist');
        const newPlaylistNameInput = document.getElementById('newPlaylistName');
        const musicAddError = document.getElementById('musicAddError');
        const musicAddSuccess = document.getElementById('musicAddSuccess');

        const playlistsSection = document.getElementById('playlistsSection');
        const playlistGrid = document.getElementById('playlistGrid');
        const noPlaylistsMessage = document.getElementById('noPlaylistsMessage');
        const showCreatePlaylistFormButton = document.getElementById('showCreatePlaylistFormButton');
        const createPlaylistForm = document.getElementById('createPlaylistForm');
        const newPlaylistTitleInput = document.getElementById('newPlaylistTitle');

        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const searchResultsContainer = document.getElementById('searchResults');

        let currentUser = null;
        let currentPlayQueue = [];
        let currentTrackIndex = 0;
        let userPlaylists = [];


        // --- Utility Functions ---
        function showForm(formContainer) {
            formContainer.classList.add('active');
        }
        function hideForm(formContainer) {
            formContainer.classList.remove('active');
        }
        function clearErrors() {
            loginError.textContent = '';
            registerError.textContent = '';
            profileEditError.textContent = '';
            profileEditSuccess.textContent = '';
            musicAddError.textContent = '';
            musicAddSuccess.textContent = '';
        }

        // Cloudinary Upload Function
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', cloudinaryPreset);

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryCloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.secure_url) {
                    return data.secure_url;
                } else {
                    throw new Error(data.error ? data.error.message : 'Cloudinary upload failed');
                }
            } catch (error) {
                console.error("Cloudinary Upload Error:", error);
                return null;
            }
        }


        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            clearErrors();
            if (user) {
                currentUser = user;
                authScreen.classList.add('hidden');
                appWrapper.classList.remove('hidden');
                loginFormContainer.classList.remove('active');
                registerFormContainer.classList.remove('active');
                loadUserData(user.uid);
                loadUserPlaylists(user.uid);
                navigateToSection('homeSection'); // Default to home
                loadHomeContent();
            } else {
                currentUser = null;
                authScreen.classList.remove('hidden');
                appWrapper.classList.add('hidden');
                profileModal.classList.remove('active');
                currentPlayQueue = [];
                currentTrackIndex = 0;
                audioPlayer.pause();
                audioPlayer.src = '';
            }
        });

        showLoginButton.addEventListener('click', () => { clearErrors(); showForm(loginFormContainer); });
        showRegisterButton.addEventListener('click', () => { clearErrors(); showForm(registerFormContainer); });

        document.querySelectorAll('.closeButton').forEach(button => {
            button.addEventListener('click', () => {
                hideForm(document.getElementById(button.dataset.targetForm));
            });
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.loginEmail.value;
            const password = loginForm.loginPassword.value;
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle UI update
            } catch (error) {
                console.error("Login error:", error);
                loginError.textContent = error.message.replace('Firebase: ', '');
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = registerForm.registerFullName.value;
            const username = registerForm.registerUsername.value;
            const email = registerForm.registerEmail.value;
            const password = registerForm.registerPassword.value;
            const gender = registerForm.registerGender.value;
            const dob = registerForm.registerDob.value;
            const profilePicFile = registerForm.registerProfilePic.files[0];
            registerError.textContent = '';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                let profileImageUrl = "https://via.placeholder.com/100"; // Default
                if (profilePicFile) {
                    const uploadedUrl = await uploadToCloudinary(profilePicFile);
                    if (uploadedUrl) profileImageUrl = uploadedUrl;
                }

                // Save additional user info to Realtime Database
                await set(ref(database, 'users/' + user.uid), {
                    uid: user.uid,
                    fullName: fullName,
                    username: username,
                    email: email,
                    gender: gender,
                    dob: dob,
                    profileImageUrl: profileImageUrl,
                    createdAt: new Date().toISOString()
                });

                await updateProfile(user, { displayName: username, photoURL: profileImageUrl });
                // onAuthStateChanged will handle UI update

            } catch (error) {
                console.error("Registration error:", error);
                registerError.textContent = error.message.replace('Firebase: ', '');
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
            }
        });
        mobileLogoutButton.addEventListener('click', async () => { // For mobile menu
            try {
                await signOut(auth);
                mobileNavMenu.classList.remove('open'); // Close menu on logout
            } catch (error) {
                console.error("Logout error:", error);
            }
        });


        // --- Profile Management ---
        headerProfilePic.addEventListener('click', () => {
            if (!currentUser) return;
            clearErrors();
            profileEditSuccess.textContent = ''; // Clear previous success messages
            // Populate modal with current user data
            get(child(ref(database), `users/${currentUser.uid}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    profileEditFullName.value = userData.fullName || '';
                    profileEditUsername.value = userData.username || '';
                    profileEditGender.value = userData.gender || '';
                    profileEditDob.value = userData.dob || '';
                    profileModalPreview.src = userData.profileImageUrl || 'https://via.placeholder.com/100';
                }
            });
            profileModal.classList.add('active');
        });

        profileEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const newFullName = profileEditFullName.value;
            const newUsername = profileEditUsername.value;
            const newGender = profileEditGender.value;
            const newDob = profileEditDob.value;
            const newProfilePicFile = profileEditForm.profileEditProfilePic.files[0];
            profileEditError.textContent = '';
            profileEditSuccess.textContent = '';

            try {
                let newProfileImageUrl = profileModalPreview.src;
                if (newProfilePicFile) {
                    const uploadedUrl = await uploadToCloudinary(newProfilePicFile);
                    if (uploadedUrl) newProfileImageUrl = uploadedUrl;
                    else throw new Error("Profile picture upload failed.");
                }

                const updates = {
                    fullName: newFullName,
                    username: newUsername,
                    gender: newGender,
                    dob: newDob,
                    profileImageUrl: newProfileImageUrl
                };

                await update(ref(database, 'users/' + currentUser.uid), updates);
                await updateProfile(auth.currentUser, {
                    displayName: newUsername,
                    photoURL: newProfileImageUrl
                });

                headerProfilePic.src = newProfileImageUrl; // Update header icon immediately
                profileEditSuccess.textContent = "Profile updated successfully!";
                setTimeout(() => { profileModal.classList.remove('active'); profileEditSuccess.textContent = '';}, 2000);

            } catch (error) {
                console.error("Profile update error:", error);
                profileEditError.textContent = error.message;
            }
        });

        async function loadUserData(uid) {
            const userRef = ref(database, 'users/' + uid);
            onValue(userRef, (snapshot) => { // Use onValue for real-time updates if desired
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    headerProfilePic.src = userData.profileImageUrl || 'https://via.placeholder.com/100';
                    // Potentially update other UI elements if needed
                }
            });
        }


        // --- Navigation ---
        mobileHamburgerButton.addEventListener('click', () => {
            mobileNavMenu.classList.toggle('open');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = link.dataset.section;
                navigateToSection(sectionId);
                mobileNavMenu.classList.remove('open'); // Close mobile menu if open

                // Update active class for nav links
                navLinks.forEach(nav => nav.classList.remove('active'));
                document.querySelectorAll(`.navLink[data-section="${sectionId}"]`).forEach(activeLink => activeLink.classList.add('active'));
            });
        });

        function navigateToSection(sectionId) {
            contentSections.forEach(section => {
                section.classList.remove('active');
            });
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.add('active');
                // Load content specific to the section
                if (sectionId === 'homeSection') loadHomeContent();
                else if (sectionId === 'playlistsSection') renderPlaylists();
                else if (sectionId === 'musicAddSection') populatePlaylistDropdownForMusicAdd();
                else if (sectionId === 'searchSection') searchResultsContainer.innerHTML = '<p>Start typing to search for music across all users.</p>'; // Reset search
            }
        }


        // --- Home Section & Music Player ---
        function loadHomeContent() {
            if (!currentUser) return;
            // For now, let's try to load all songs by this user, or a default "library"
            // A more robust system would load songs from a selected playlist
            // Let's assume we have a global `currentPlayQueue` that gets populated by selecting a playlist or search
            if (currentPlayQueue.length === 0) {
                // Try to load user's "All Music" or first playlist as default
                const songsRef = query(ref(database, 'songs'), orderByChild('userId'), equalTo(currentUser.uid));
                get(songsRef).then(snapshot => {
                    if (snapshot.exists()) {
                        const songs = [];
                        snapshot.forEach(childSnapshot => {
                            songs.push({ id: childSnapshot.key, ...childSnapshot.val() });
                        });
                        currentPlayQueue = songs;
                        currentTrackIndex = 0;
                        if (songs.length > 0) renderPlayerAndQueue();
                        else renderNoMusicMessage();
                    } else {
                         renderNoMusicMessage();
                    }
                }).catch(error => {
                    console.error("Error fetching initial songs:", error);
                    renderNoMusicMessage();
                });

            } else {
                renderPlayerAndQueue();
            }
        }

        function renderNoMusicMessage() {
            homeMusicContent.innerHTML = `
                <div class="noMusicMessage">
                    <i class="fas fa-music"></i>
                    <p>Your music library is empty.</p>
                    <button id="goAddMusicButton">Add Your First Song!</button>
                </div>`;
            document.getElementById('goAddMusicButton')?.addEventListener('click', () => navigateToSection('musicAddSection'));
        }

        function renderPlayerAndQueue() {
            if (currentPlayQueue.length === 0 || currentTrackIndex >= currentPlayQueue.length) {
                renderNoMusicMessage();
                return;
            }
            const track = currentPlayQueue[currentTrackIndex];
            if (!track) {
                 renderNoMusicMessage(); return;
            }

            homeMusicContent.innerHTML = `
                <div class="musicPlayerContainer">
                    <img src="${track.imageUrl || 'https://via.placeholder.com/300'}" alt="${track.name}" class="musicCover" id="playerCover">
                    <div class="musicInfo">
                        <h3 id="playerName">${track.name || 'Unknown Title'}</h3>
                        <p id="playerArtist">${track.artist || 'Unknown Artist'}</p>
                    </div>
                    <div class="musicProgress" id="musicProgressContainer">
                        <div class="musicProgressBar" id="musicProgressBar"></div>
                    </div>
                    <div class="timeDisplay">
                        <span id="currentTime">0:00</span>
                        <span id="totalDuration">0:00</span>
                    </div>
                    <div class="musicControls">
                        <button id="prevButton"><i class="fas fa-step-backward"></i></button>
                        <button id="playPauseButton" class="playPauseButton"><i class="fas fa-play"></i></button>
                        <button id="nextButton"><i class="fas fa-step-forward"></i></button>
                    </div>
                </div>
                <div class="musicList" id="homeQueueList">
                    <h4>Up Next:</h4>
                    </div>
            `;

            loadTrack(track);
            renderQueueList('homeQueueList');
            setupPlayerControls();
        }

        function renderQueueList(containerId) {
            const queueListContainer = document.getElementById(containerId);
            if (!queueListContainer) return;
            queueListContainer.innerHTML = '<h4>Up Next:</h4>'; // Reset header
             if (currentPlayQueue.length <= 1) {
                queueListContainer.innerHTML = ''; // No "Up Next" if only one or no song
                return;
            }

            currentPlayQueue.forEach((song, index) => {
                if (index === currentTrackIndex && containerId === 'homeQueueList') return; // Don't show current playing in "up next"

                const item = document.createElement('div');
                item.classList.add('musicListItem');
                if (index === currentTrackIndex) item.classList.add('playing');
                item.dataset.index = index;
                item.innerHTML = `
                    <img src="${song.imageUrl || 'https://via.placeholder.com/50'}" alt="${song.name}">
                    <div class="musicListItemInfo">
                        <h4>${song.name}</h4>
                        <p>${song.artist || 'Unknown Artist'}</p>
                    </div>
                `;
                item.addEventListener('click', () => {
                    playTrackFromQueue(index);
                });
                queueListContainer.appendChild(item);
            });
        }


        function loadTrack(track) {
            if (!track || !track.audioUrl) {
                console.error("Track data or audio URL missing:", track);
                // Potentially play next or show error
                if(currentPlayQueue.length > 0) playNext();
                else renderNoMusicMessage();
                return;
            }
            document.getElementById('playerCover').src = track.imageUrl || 'https://via.placeholder.com/300';
            document.getElementById('playerName').textContent = track.name || 'Unknown Title';
            document.getElementById('playerArtist').textContent = track.artist || 'Unknown Artist';
            audioPlayer.src = track.audioUrl;
            // Reset progress bar and time
            document.getElementById('musicProgressBar').style.width = '0%';
            document.getElementById('currentTime').textContent = '0:00';
            document.getElementById('totalDuration').textContent = '0:00';

            // Update active item in queue list
            document.querySelectorAll('#homeQueueList .musicListItem.playing').forEach(el => el.classList.remove('playing'));
            const currentQueueItem = document.querySelector(`#homeQueueList .musicListItem[data-index="${currentTrackIndex}"]`);
            if (currentQueueItem) currentQueueItem.classList.add('playing');
        }

        function setupPlayerControls() {
            const playPauseBtn = document.getElementById('playPauseButton');
            const prevBtn = document.getElementById('prevButton');
            const nextBtn = document.getElementById('nextButton');
            const progressContainer = document.getElementById('musicProgressContainer');

            playPauseBtn.onclick = togglePlayPause;
            prevBtn.onclick = playPrev;
            nextBtn.onclick = playNext;

            audioPlayer.ontimeupdate = updateProgress;
            audioPlayer.onloadedmetadata = () => {
                document.getElementById('totalDuration').textContent = formatTime(audioPlayer.duration);
            };
            audioPlayer.onended = playNext; // Autoplay next song

            progressContainer.onclick = (e) => {
                const width = progressContainer.clientWidth;
                const clickX = e.offsetX;
                audioPlayer.currentTime = (clickX / width) * audioPlayer.duration;
            };
        }

        function togglePlayPause() {
            const playPauseBtnIcon = document.querySelector('#playPauseButton i');
            if (audioPlayer.paused || audioPlayer.ended) {
                audioPlayer.play().catch(e => console.error("Play error:", e));
                playPauseBtnIcon.classList.remove('fa-play');
                playPauseBtnIcon.classList.add('fa-pause');
            } else {
                audioPlayer.pause();
                playPauseBtnIcon.classList.remove('fa-pause');
                playPauseBtnIcon.classList.add('fa-play');
            }
        }

        function playNext() {
            currentTrackIndex++;
            if (currentTrackIndex >= currentPlayQueue.length) {
                currentTrackIndex = 0; // Loop back to start or stop
                if (currentPlayQueue.length === 0) { // if queue became empty
                    renderNoMusicMessage();
                    audioPlayer.pause();
                    audioPlayer.src = '';
                    return;
                }
            }
            if (currentPlayQueue[currentTrackIndex]) {
                loadTrack(currentPlayQueue[currentTrackIndex]);
                audioPlayer.play().catch(e => console.error("Play error:", e));
                 if(document.querySelector('#playPauseButton i')) {
                    document.querySelector('#playPauseButton i').classList.remove('fa-play');
                    document.querySelector('#playPauseButton i').classList.add('fa-pause');
                }
                renderQueueList('homeQueueList'); // Re-render queue to update "playing" state visual
            } else if (currentPlayQueue.length > 0) { // If somehow index is bad but queue not empty, reset
                 currentTrackIndex = 0;
                 playNext();
            }
        }

        function playPrev() {
            currentTrackIndex--;
            if (currentTrackIndex < 0) {
                currentTrackIndex = currentPlayQueue.length - 1; // Loop to end
                 if (currentTrackIndex < 0) currentTrackIndex = 0; // handles empty or single song queue
            }
             if (currentPlayQueue[currentTrackIndex]) {
                loadTrack(currentPlayQueue[currentTrackIndex]);
                audioPlayer.play().catch(e => console.error("Play error:", e));
                if(document.querySelector('#playPauseButton i')) {
                    document.querySelector('#playPauseButton i').classList.remove('fa-play');
                    document.querySelector('#playPauseButton i').classList.add('fa-pause');
                }
                 renderQueueList('homeQueueList');
            } else if (currentPlayQueue.length > 0) {
                currentTrackIndex = 0;
                playPrev();
            }
        }

        function playTrackFromQueue(index) {
            currentTrackIndex = index;
            if (currentPlayQueue[currentTrackIndex]) {
                loadTrack(currentPlayQueue[currentTrackIndex]);
                audioPlayer.play().catch(e => console.error("Play error:", e));
                 if(document.querySelector('#playPauseButton i')) {
                    document.querySelector('#playPauseButton i').classList.remove('fa-play');
                    document.querySelector('#playPauseButton i').classList.add('fa-pause');
                 }
                 renderQueueList('homeQueueList'); // Re-render queue to update "playing" state visual
                 navigateToSection('homeSection'); // Switch to home view if not already there
            }
        }


        function updateProgress() {
            const { duration, currentTime } = audioPlayer;
            const progressPercent = (currentTime / duration) * 100;
            document.getElementById('musicProgressBar').style.width = `${progressPercent}%`;
            document.getElementById('currentTime').textContent = formatTime(currentTime);
            if(duration && !isNaN(duration)){ // Update total duration if it was NaN initially
                 document.getElementById('totalDuration').textContent = formatTime(duration);
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === Infinity) return "0:00";
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }


        // --- Music Add Section ---
        musicCoverImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    musicCoverPreview.src = event.target.result;
                    musicCoverPreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                musicCoverPreview.style.display = 'none';
            }
        });

        async function populatePlaylistDropdownForMusicAdd() {
            if (!currentUser) return;
            musicPlaylistSelect.innerHTML = '<option value="">Select Playlist</option><option value="_CREATE_NEW_">-- Create New Playlist --</option>'; // Reset
            const playlistsRef = query(ref(database, 'playlists'), orderByChild('userId'), equalTo(currentUser.uid));
            get(playlistsRef).then(snapshot => {
                if (snapshot.exists()) {
                    userPlaylists = []; // Update local cache
                    snapshot.forEach(childSnapshot => {
                        const playlist = { id: childSnapshot.key, ...childSnapshot.val() };
                        userPlaylists.push(playlist);
                        const option = document.createElement('option');
                        option.value = playlist.id;
                        option.textContent = playlist.name;
                        musicPlaylistSelect.appendChild(option);
                    });
                }
            });
        }


        musicAddForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const name = musicNameInput.value.trim();
            const artist = musicArtistInput.value.trim();
            const audioUrl = musicFileUrlInput.value.trim();
            const coverFile = musicCoverImageInput.files[0];
            let playlistId = musicPlaylistSelect.value;
            const newPlaylistName = newPlaylistNameInput.value.trim();

            musicAddError.textContent = '';
            musicAddSuccess.textContent = '';

            if (!name || !audioUrl || !coverFile) {
                musicAddError.textContent = "Music title, audio URL, and cover image are required.";
                return;
            }

            let finalPlaylistId = playlistId;
            let finalPlaylistName = "";

            try {
                // Handle playlist
                if (playlistId === '_CREATE_NEW_' || (!playlistId && newPlaylistName)) {
                    finalPlaylistName = newPlaylistName || "My New Playlist"; // Default if new but no name
                    if (!newPlaylistName && playlistId === '_CREATE_NEW_') {
                         musicAddError.textContent = "Please enter a name for the new playlist.";
                         return;
                    }
                    const newPlaylistRef = push(ref(database, 'playlists'));
                    finalPlaylistId = newPlaylistRef.key;
                    await set(newPlaylistRef, {
                        userId: currentUser.uid,
                        name: finalPlaylistName,
                        createdAt: new Date().toISOString(),
                        songs: {} // Initialize songs object for the new playlist
                    });
                    // Add to local cache and dropdown
                    userPlaylists.push({id: finalPlaylistId, name: finalPlaylistName, userId: currentUser.uid});
                    populatePlaylistDropdownForMusicAdd(); // Refresh dropdown
                    musicPlaylistSelect.value = finalPlaylistId; // Select the newly created one
                } else if (!playlistId && userPlaylists.length === 0) {
                    // No playlist selected and no existing playlists, create a default "Library"
                    finalPlaylistName = "Library";
                    const defaultPlaylistRef = push(ref(database, 'playlists'));
                    finalPlaylistId = defaultPlaylistRef.key;
                    await set(defaultPlaylistRef, {
                        userId: currentUser.uid,
                        name: finalPlaylistName,
                        createdAt: new Date().toISOString(),
                        songs: {}
                    });
                     userPlaylists.push({id: finalPlaylistId, name: finalPlaylistName, userId: currentUser.uid});
                    populatePlaylistDropdownForMusicAdd();
                    musicPlaylistSelect.value = finalPlaylistId;
                } else if (!playlistId) {
                    musicAddError.textContent = "Please select a playlist or create a new one.";
                    return;
                }


                const imageUrl = await uploadToCloudinary(coverFile);
                if (!imageUrl) throw new Error("Cover image upload failed.");

                const newSongRef = push(ref(database, 'songs'));
                const songId = newSongRef.key;
                const songData = {
                    id: songId,
                    userId: currentUser.uid,
                    name: name,
                    artist: artist,
                    audioUrl: audioUrl,
                    imageUrl: imageUrl,
                    playlistIds: [finalPlaylistId], // Store as an array for potential multiple playlists later
                    createdAt: new Date().toISOString()
                };
                await set(newSongRef, songData);

                // Add song to the selected/created playlist
                await update(ref(database, `playlists/${finalPlaylistId}/songs`), {
                    [songId]: true // Using songId as key for easy add/remove
                });


                musicAddSuccess.textContent = `"${name}" added successfully ${finalPlaylistName ? 'to playlist "' + finalPlaylistName + '"' : ''}!`;
                musicAddForm.reset();
                musicCoverPreview.style.display = 'none';
                newPlaylistNameInput.value = '';
                // Optionally, navigate to home or refresh current view
                loadHomeContent(); // Refresh home if new music might appear there
                loadUserPlaylists(currentUser.uid); // Refresh playlist cache

            } catch (error) {
                console.error("Add Music Error:", error);
                musicAddError.textContent = error.message;
            }
        });


        // --- Playlists Section ---
        async function loadUserPlaylists(uid) {
            const playlistsRef = query(ref(database, 'playlists'), orderByChild('userId'), equalTo(uid));
            onValue(playlistsRef, (snapshot) => { // onValue for real-time updates
                userPlaylists = [];
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        userPlaylists.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                }
                renderPlaylists();
                populatePlaylistDropdownForMusicAdd(); // Also update dropdown in add music form
            });
        }

        function renderPlaylists() {
            playlistGrid.innerHTML = '';
            if (userPlaylists.length === 0) {
                noPlaylistsMessage.classList.remove('hidden');
            } else {
                noPlaylistsMessage.classList.add('hidden');
                userPlaylists.forEach(playlist => {
                    const playlistItem = document.createElement('div');
                    playlistItem.classList.add('playlistItem');
                    playlistItem.dataset.playlistId = playlist.id;
                    const songCount = playlist.songs ? Object.keys(playlist.songs).length : 0;
                    playlistItem.innerHTML = `
                        <i class="fas fa-compact-disc"></i>
                        <h3>${playlist.name}</h3>
                        <p>${songCount} song(s)</p>
                    `;
                    playlistItem.addEventListener('click', () => loadPlaylistIntoPlayer(playlist.id));
                    playlistGrid.appendChild(playlistItem);
                });
            }
        }

        showCreatePlaylistFormButton.addEventListener('click', () => {
            createPlaylistForm.classList.toggle('hidden');
            if (!createPlaylistForm.classList.contains('hidden')) {
                newPlaylistTitleInput.focus();
            }
        });

        createPlaylistForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const title = newPlaylistTitleInput.value.trim();
            if (!title) return;

            try {
                const newPlaylistRef = push(ref(database, 'playlists'));
                await set(newPlaylistRef, {
                    userId: currentUser.uid,
                    name: title,
                    createdAt: new Date().toISOString(),
                    songs: {}
                });
                newPlaylistTitleInput.value = '';
                createPlaylistForm.classList.add('hidden');
                // loadUserPlaylists will update the view due to onValue
            } catch (error) {
                console.error("Create Playlist Error:", error);
                alert("Error creating playlist: " + error.message);
            }
        });

        async function loadPlaylistIntoPlayer(playlistId) {
            const playlist = userPlaylists.find(p => p.id === playlistId);
            if (!playlist || !playlist.songs) {
                currentPlayQueue = [];
                currentTrackIndex = 0;
                renderNoMusicMessage();
                navigateToSection('homeSection');
                return;
            }

            const songIds = Object.keys(playlist.songs);
            if (songIds.length === 0) {
                 currentPlayQueue = [];
                 currentTrackIndex = 0;
                 renderNoMusicMessage(); // Show no music if playlist is empty
                 navigateToSection('homeSection');
                 return;
            }

            const songPromises = songIds.map(songId => get(child(ref(database), `songs/${songId}`)));
            Promise.all(songPromises).then(snapshots => {
                currentPlayQueue = snapshots
                    .filter(snap => snap.exists())
                    .map(snap => ({ id: snap.key, ...snap.val() }));
                currentTrackIndex = 0;
                if (currentPlayQueue.length > 0) {
                    renderPlayerAndQueue();
                } else {
                    renderNoMusicMessage();
                }
                navigateToSection('homeSection');
            }).catch(error => {
                console.error("Error loading playlist songs:", error);
                renderNoMusicMessage();
                navigateToSection('homeSection');
            });
        }

        // --- Search Section ---
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        async function performSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            searchResultsContainer.innerHTML = '<p>Searching...</p>';
            if (!searchTerm) {
                searchResultsContainer.innerHTML = '<p>Please enter a search term.</p>';
                return;
            }

            try {
                // This is a simplified search. For large datasets, Firebase doesn't support
                // native full-text search well on Realtime Database.
                // You might need a more complex query or a third-party search service (e.g., Algolia) for production.
                // This will fetch ALL songs and filter client-side, which is not scalable.
                // For "search music from everyone registered", we fetch all songs.
                const songsRef = ref(database, 'songs');
                const snapshot = await get(songsRef);
                let results = [];
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const song = { id: childSnapshot.key, ...childSnapshot.val() };
                        if ((song.name && song.name.toLowerCase().includes(searchTerm)) ||
                            (song.artist && song.artist.toLowerCase().includes(searchTerm))) {
                            results.push(song);
                        }
                    });
                }

                renderSearchResults(results);

            } catch (error) {
                console.error("Search error:", error);
                searchResultsContainer.innerHTML = `<p>Error during search: ${error.message}</p>`;
            }
        }

        function renderSearchResults(results) {
            searchResultsContainer.innerHTML = '';
            if (results.length === 0) {
                searchResultsContainer.innerHTML = '<p>No songs found matching your search.</p>';
                return;
            }
            results.forEach((song, index) => {
                const item = document.createElement('div');
                item.classList.add('musicListItem');
                item.dataset.songId = song.id; // Use song.id
                item.innerHTML = `
                    <img src="${song.imageUrl || 'https://via.placeholder.com/50'}" alt="${song.name}">
                    <div class="musicListItemInfo">
                        <h4>${song.name}</h4>
                        <p>${song.artist || 'Unknown Artist'}</p>
                    </div>
                    <button class="playSearchResultButton" data-index="${index}" style="margin-left: auto; background-color: #00ffc3; color: #111; padding: 5px 10px; font-size: 0.8rem;">Play</button>
                `;
                // Add event listener to play this song
                // This needs to set currentPlayQueue to the search results and play the specific song
                item.querySelector('.playSearchResultButton').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent triggering outer click if any
                    currentPlayQueue = [...results]; // Set the play queue to the search results
                    playTrackFromQueue(parseInt(e.target.dataset.index));
                });
                searchResultsContainer.appendChild(item);
            });
        }

        // Initial call if needed (though onAuthStateChanged handles initial load)
        // navigateToSection('homeSection');

    </script>

</body>
</html>



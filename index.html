<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HarmonyHub - Your Music Space</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* General Styles */
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
            background: linear-gradient(45deg, #ff007f, #00ffcc, #ffcc00, #7f00ff, #007fff, #ff7f00);
            background-size: 600% 600%;
            animation: gradientAnimation 30s ease infinite;
            display: flex;
            flex-direction: column;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .hidden {
            display: none !important;
        }

        .smoothTransition {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out, max-height 0.5s ease-in-out;
        }

        /* Buttons */
        .appButton {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 5px;
        }

        .appButton:hover {
            background-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .appButtonIcon {
            padding: 10px;
            border: none;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s ease;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .appButtonIcon:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }


        /* Landing Page */
        .landingView {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        .landingBanner {
            margin-bottom: 30px;
        }

        .landingBanner h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .landingBanner p {
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Auth Forms */
        .authFormsContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1000;
        }

        .authFormsContainer.visible {
            opacity: 1;
            visibility: visible;
        }

        .authForm {
            background-color: rgba(0,0,0,0.7);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .authForm h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .authForm label {
            display: block;
            margin-bottom: 5px;
            color: rgba(255,255,255,0.8);
        }

        .authForm input[type="text"],
        .authForm input[type="email"],
        .authForm input[type="password"],
        .authForm input[type="date"],
        .authForm select,
        .authForm input[type="file"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.3);
            background-color: rgba(255,255,255,0.1);
            color: white;
        }
        .authForm input[type="file"] {
            padding: 3px;
        }

        .authForm .formActions {
            text-align: center;
        }
        .authForm .toggleFormLink {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: #00ffcc;
            cursor: pointer;
        }
        .authForm .errorMessage {
            color: #ff4d4d;
            text-align: center;
            margin-bottom: 10px;
            font-size: 0.9em;
        }


        /* Main App View */
        .mainAppView {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .appHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .profileArea {
            cursor: pointer;
        }

        .userProfileImage {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #fff;
            object-fit: cover;
        }

        .desktopNav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
        }

        .desktopNav li {
            margin-left: 25px;
        }

        .desktopNav a {
            color: white;
            text-decoration: none;
            font-size: 1.1em;
            transition: color 0.3s ease;
        }
        .desktopNav a:hover, .desktopNav a.active {
            color: #00ffcc;
        }


        .hamburgerIcon {
            display: none; /* Hidden on desktop */
            font-size: 24px;
            cursor: pointer;
        }

        .mainContent {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; /* For scrollable content */
        }
        .contentSection {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }


        /* Mobile Navigation (Bottom Bar) */
        .mobileNav {
            display: none; /* Hidden on desktop */
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            padding: 10px 0;
            justify-content: space-around;
            align-items: center;
            z-index: 999;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .mobileNav a {
            color: white;
            text-decoration: none;
            text-align: center;
            font-size: 12px;
            flex-grow: 1;
        }
        .mobileNav a i {
            display: block;
            font-size: 20px;
            margin-bottom: 3px;
        }
        .mobileNav a:hover, .mobileNav a.active {
            color: #00ffcc;
        }

        /* Mobile Hamburger Menu (Slide-in) */
        .mobileMenu {
            position: fixed;
            top: 0;
            right: -300px; /* Start off-screen */
            width: 280px;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }
        .mobileMenu.open {
            right: 0;
        }
        .mobileMenuNavClose {
            text-align: right;
            font-size: 24px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .mobileMenu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .mobileMenu li {
            margin-bottom: 20px;
        }
        .mobileMenu a {
            color: white;
            text-decoration: none;
            font-size: 1.3em;
            display: block;
            padding: 10px;
            border-radius: 5px;
        }
        .mobileMenu a:hover, .mobileMenu a.active {
            background-color: rgba(255,255,255,0.1);
            color: #00ffcc;
        }


        /* Profile Edit Modal */
        .profileEditModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1005; /* Higher than auth forms */
        }
        .profileEditModal.visible {
            opacity: 1;
            visibility: visible;
        }
        .profileEditModalContent {
            background-color: rgba(20,20,30,0.9);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        .profileEditModalContent h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .profileEditModalContent label {
            display: block;
            margin-bottom: 5px;
            color: rgba(255,255,255,0.8);
        }
        .profileEditModalContent input[type="text"],
        .profileEditModalContent input[type="date"],
        .profileEditModalContent select,
        .profileEditModalContent input[type="file"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.3);
            background-color: rgba(255,255,255,0.1);
            color: white;
        }
        .profileEditModalContent .currentProfilePic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 10px auto;
            display: block;
        }
        .profileEditModalActions {
            text-align: right;
            margin-top: 20px;
        }

        /* Home View - Music Player */
        .homeViewContent .noMusicPrompt {
            text-align: center;
            padding: 50px 20px;
            animation: pulseAnimation 2s infinite;
        }
        .homeViewContent .noMusicPrompt h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        .homeViewContent .noMusicPrompt p {
            color: rgba(255,255,255,0.7);
        }
        @keyframes pulseAnimation {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .musicPlayerContainer {
            max-width: 450px;
            margin: 20px auto;
            background-color: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .musicPlayerAlbumArt {
            width: 100%;
            max-width: 300px;
            height: auto;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 8px;
            margin: 0 auto 15px auto;
            display: block;
        }
        .musicPlayerInfo h3 { /* Song Title */
            font-size: 1.4em;
            margin: 0 0 5px 0;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .musicPlayerInfo p { /* Artist Name */
            font-size: 0.9em;
            color: rgba(255,255,255,0.7);
            text-align: center;
            margin: 0 0 15px 0;
        }
        .musicPlayerProgress {
            width: 100%;
            height: 8px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
            overflow: hidden; /* Ensure inner bar stays within rounded corners */
        }
        .musicPlayerProgressBar {
            width: 0%;
            height: 100%;
            background-color: #00ffcc;
            border-radius: 4px; /* Match parent for smooth look */
            transition: width 0.1s linear; /* Smooth progress update */
        }
        .musicPlayerTime {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: rgba(255,255,255,0.6);
            margin-bottom: 15px;
        }
        .musicPlayerControls {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .musicPlayerControls .playButton {
            font-size: 28px; /* Larger play button */
            width: 50px;
            height: 50px;
        }

        /* Music List (for Home, Search results, Playlist songs) */
        .musicList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }
        .musicListItem {
            background-color: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .musicListItem:hover {
            transform: translateY(-5px);
            background-color: rgba(0,0,0,0.5);
        }
        .musicListItem img {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .musicListItemTitle {
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 3px;
        }
        .musicListItemArtist {
            font-size: 0.75em;
            color: rgba(255,255,255,0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* Music Add View */
        .musicAddViewContent form label, .playlistsViewContent form label {
            margin-top: 10px;
        }
        .musicAddViewContent form input, .musicAddViewContent form select,
        .playlistsViewContent form input {
             width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.3);
            background-color: rgba(255,255,255,0.1);
            color: white;
        }

        /* Playlists View */
        .playlistGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .playlistItem {
            background-color: rgba(0,0,0,0.4);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .playlistItem:hover {
            background-color: rgba(0,0,0,0.6);
        }
        .playlistItem i { /* Icon for playlist */
            font-size: 3em;
            margin-bottom: 10px;
            color: #00ffcc;
        }
        .playlistItem h4 {
            margin: 0;
            font-size: 1.2em;
        }
        .noPlaylistsPrompt {
            text-align: center;
            padding: 50px 20px;
        }


        /* Search View */
        .searchViewContent input[type="search"] {
            width: calc(100% - 22px);
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.3);
            background-color: rgba(255,255,255,0.1);
            color: white;
            font-size: 1em;
        }
        .searchResultsContainer {
            margin-top: 20px;
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            .appHeader {
                padding: 10px 15px;
            }
            .desktopNav {
                display: none; /* Hide desktop nav on mobile */
            }
            .hamburgerIcon {
                display: block; /* Show hamburger on mobile */
            }
            .mobileNav {
                display: flex; /* Show mobile bottom nav */
            }
            .mainContent {
                padding: 15px;
                padding-bottom: 70px; /* Space for fixed bottom nav */
            }
            .musicList {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 15px;
            }
            .musicPlayerContainer {
                margin: 10px auto;
                padding: 15px;
            }
            .playlistGrid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
        @media (max-width: 480px) {
            .landingBanner h1 {
                font-size: 2.2em;
            }
            .authForm {
                padding: 20px;
            }
            .userProfileImage {
                width: 40px;
                height: 40px;
            }
            .musicList {
                grid-template-columns: repeat(2, 1fr); /* Simpler 2-column layout on small screens */
                gap: 10px;
            }
             .musicListItemTitle {
                font-size: 0.85em;
            }
            .musicListItemArtist {
                font-size: 0.7em;
            }
            .musicPlayerControls .appButtonIcon {
                font-size: 16px;
                width: 35px;
                height: 35px;
            }
            .musicPlayerControls .playButton {
                font-size: 24px;
                width: 45px;
                height: 45px;
            }
        }

    </style>
</head>
<body>

    <div id="landingView" class="landingView">
        <div class="landingBanner">
            <h1>Welcome to HarmonyHub</h1>
            <p>Your personal music streaming experience.</p>
        </div>
        <div>
            <button id="showLoginBtn" class="appButton">Login</button>
            <button id="showRegisterBtn" class="appButton">Register</button>
        </div>
    </div>

    <div id="authFormsContainer" class="authFormsContainer">
        <form id="loginForm" class="authForm hidden">
            <h2>Login</h2>
            <div id="loginError" class="errorMessage"></div>
            <div>
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div>
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" required>
            </div>
            <div class="formActions">
                <button type="submit" class="appButton">Login</button>
            </div>
            <p class="toggleFormLink" data-form="registerForm">Don't have an account? Register</p>
        </form>

        <form id="registerForm" class="authForm hidden">
            <h2>Register</h2>
            <div id="registerError" class="errorMessage"></div>
            <div>
                <label for="registerFullName">Full Name</label>
                <input type="text" id="registerFullName" required>
            </div>
            <div>
                <label for="registerUsername">Username</label>
                <input type="text" id="registerUsername" required>
            </div>
            <div>
                <label for="registerEmail">Email</label>
                <input type="email" id="registerEmail" required>
            </div>
            <div>
                <label for="registerPassword">Password</label>
                <input type="password" id="registerPassword" required>
            </div>
            <div>
                <label for="registerGender">Gender</label>
                <select id="registerGender">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                    <option value="prefer_not_to_say">Prefer not to say</option>
                </select>
            </div>
            <div>
                <label for="registerDob">Date of Birth (DD/MM/YYYY)</label>
                <input type="date" id="registerDob" required>
            </div>
            <div>
                <label for="registerProfilePic">Profile Picture</label>
                <input type="file" id="registerProfilePic" accept="image/*">
            </div>
            <div class="formActions">
                <button type="submit" class="appButton">Register</button>
            </div>
            <p class="toggleFormLink" data-form="loginForm">Already have an account? Login</p>
        </form>
    </div>


    <div id="mainAppView" class="mainAppView hidden">
        <header class="appHeader">
            <div id="profileArea" class="profileArea">
                <img id="userProfileImage" src="https://via.placeholder.com/50" alt="User Profile">
            </div>
            <nav id="desktopNav" class="desktopNav">
                <ul>
                    <li><a href="#" class="navLink active" data-view="homeViewContent">Home</a></li>
                    <li><a href="#" class="navLink" data-view="musicAddViewContent">Add Music</a></li>
                    <li><a href="#" class="navLink" data-view="searchViewContent">Search</a></li>
                    <li><a href="#" class="navLink" data-view="playlistsViewContent">Playlists</a></li>
                    <li><a href="#" id="logoutButton">Logout</a></li>
                </ul>
            </nav>
            <div id="hamburgerIcon" class="hamburgerIcon">
                <i class="fas fa-bars"></i>
            </div>
        </header>

        <div id="mobileMenu" class="mobileMenu">
            <div id="mobileMenuNavClose" class="mobileMenuNavClose"><i class="fas fa-times"></i></div>
            <ul>
                 <li><a href="#" class="navLink mobileNavLink active" data-view="homeViewContent">Home</a></li>
                 <li><a href="#" class="navLink mobileNavLink" data-view="musicAddViewContent">Add Music</a></li>
                 <li><a href="#" class="navLink mobileNavLink" data-view="searchViewContent">Search</a></li>
                 <li><a href="#" class="navLink mobileNavLink" data-view="playlistsViewContent">Playlists</a></li>
                 <li><a href="#" id="logoutButtonMobile">Logout</a></li>
            </ul>
        </div>


        <main id="mainContent" class="mainContent">
            <section id="homeViewContent" class="contentSection">
                <h2>My Music</h2>
                <div id="homeMusicPlayer" class="musicPlayerContainer hidden">
                    <img id="playerAlbumArt" src="https://via.placeholder.com/300" alt="Album Art" class="musicPlayerAlbumArt">
                    <div class="musicPlayerInfo">
                        <h3 id="playerSongTitle">Song Title</h3>
                        <p id="playerArtistName">Artist Name</p>
                    </div>
                    <div id="playerProgress" class="musicPlayerProgress">
                        <div id="playerProgressBar" class="musicPlayerProgressBar"></div>
                    </div>
                    <div class="musicPlayerTime">
                        <span id="playerCurrentTime">0:00</span>
                        <span id="playerTotalTime">0:00</span>
                    </div>
                    <div class="musicPlayerControls">
                        <button id="prevTrackBtn" class="appButtonIcon"><i class="fas fa-step-backward"></i></button>
                        <button id="playPauseBtn" class="appButtonIcon playButton"><i class="fas fa-play"></i></button>
                        <button id="nextTrackBtn" class="appButtonIcon"><i class="fas fa-step-forward"></i></button>
                    </div>
                </div>
                <div id="homeMusicList" class="musicList">
                    </div>
                <div id="homeNoMusicPrompt" class="noMusicPrompt hidden">
                    <h3>Your music library is empty!</h3>
                    <p>Go to "Add Music" to start building your collection, or create a playlist.</p>
                    <button class="appButton" id="promptGoToAddMusic">Add Music</button>
                </div>
            </section>

            <section id="musicAddViewContent" class="contentSection hidden">
                <h2>Add New Music</h2>
                <form id="musicAddForm">
                    <div>
                        <label for="addSongTitle">Song Title (Required)</label>
                        <input type="text" id="addSongTitle" required>
                    </div>
                    <div>
                        <label for="addArtistName">Artist Name</label>
                        <input type="text" id="addArtistName">
                    </div>
                    <div>
                        <label for="addAlbumArt">Album Art (Image File, Required)</label>
                        <input type="file" id="addAlbumArt" accept="image/*" required>
                    </div>
                    <div>
                        <label for="addMusicFile">Music File (Audio File, Required)</label>
                        <input type="file" id="addMusicFile" accept="audio/*" required>
                    </div>
                    <div>
                        <label for="addSongPlaylist">Add to Playlist:</label>
                        <select id="addSongPlaylist">
                            </select>
                        <span>or </span><button type="button" id="showCreatePlaylistFromMusicAdd" class="appButton">Create New Playlist</button>
                    </div>
                    <div id="musicAddMessage" class="errorMessage" style="margin-top:10px;"></div>
                    <button type="submit" class="appButton" style="margin-top:15px;">Upload Music</button>
                </form>
            </section>

            <section id="searchViewContent" class="contentSection hidden">
                <h2>Search Music</h2>
                <input type="search" id="searchInput" placeholder="Search for songs, artists...">
                <div id="searchResultsContainer" class="musicList">
                    </div>
                <p id="noSearchResults" class="hidden">No songs found matching your search.</p>
            </section>

            <section id="playlistsViewContent" class="contentSection hidden">
                <h2>My Playlists</h2>
                <button id="showCreatePlaylistBtn" class="appButton">Create New Playlist</button>
                <form id="createPlaylistForm" class="hidden" style="margin-top: 15px; background-color: rgba(0,0,0,0.2); padding:15px; border-radius:8px;">
                    <label for="newPlaylistName">Playlist Name:</label>
                    <input type="text" id="newPlaylistName" required>
                    <button type="submit" class="appButton">Save Playlist</button>
                    <button type="button" id="cancelCreatePlaylistBtn" class="appButton">Cancel</button>
                    <div id="playlistFormMessage" class="errorMessage" style="margin-top:10px;"></div>
                </form>
                <div id="playlistGrid" class="playlistGrid" style="margin-top:20px;">
                    </div>
                 <div id="noPlaylistsPrompt" class="noPlaylistsPrompt hidden">
                    <h3>You don't have any playlists yet.</h3>
                    <p>Create one to organize your music!</p>
                </div>
                <div id="playlistSongsView" class="hidden" style="margin-top:20px;">
                    <h3 id="playlistSongsTitle"></h3>
                    <button id="backToPlaylistsBtn" class="appButton">Back to Playlists</button>
                    <div id="playlistSongsList" class="musicList" style="margin-top:15px;">
                        </div>
                </div>
            </section>
        </main>

        <nav id="mobileNav" class="mobileNav">
            <a href="#" class="navLink mobileNavLink active" data-view="homeViewContent"><i class="fas fa-home"></i> Home</a>
            <a href="#" class="navLink mobileNavLink" data-view="musicAddViewContent"><i class="fas fa-plus-circle"></i> Add</a>
            <a href="#" class="navLink mobileNavLink" data-view="searchViewContent"><i class="fas fa-search"></i> Search</a>
            <a href="#" class="navLink mobileNavLink" data-view="playlistsViewContent"><i class="fas fa-list-music"></i> Playlists</a>
        </nav>

        <div id="profileEditModal" class="profileEditModal">
            <div class="profileEditModalContent">
                <h2>Edit Profile</h2>
                <form id="profileEditForm">
                    <img id="editCurrentProfilePic" src="https://via.placeholder.com/100" alt="Current Profile Picture" class="currentProfilePic">
                    <div>
                        <label for="editFullName">Full Name</label>
                        <input type="text" id="editFullName" required>
                    </div>
                    <div>
                        <label for="editUsername">Username</label>
                        <input type="text" id="editUsername" required>
                    </div>
                    <div>
                        <label for="editGender">Gender</label>
                        <select id="editGender">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                            <option value="prefer_not_to_say">Prefer not to say</option>
                        </select>
                    </div>
                    <div>
                        <label for="editDob">Date of Birth</label>
                        <input type="date" id="editDob" required>
                    </div>
                    <div>
                        <label for="editProfilePicFile">New Profile Picture (Optional)</label>
                        <input type="file" id="editProfilePicFile" accept="image/*">
                    </div>
                    <div id="profileEditMessage" class="errorMessage"></div>
                    <div class="profileEditModalActions">
                        <button type="button" id="cancelProfileEdit" class="appButton">Cancel</button>
                        <button type="submit" class="appButton">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <audio id="audioPlayer"></audio>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, set, get, child, update, push, serverTimestamp, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDJVgACPnByrvJBrrpSqPbyjztKIYLCMg0", // REPLACE WITH YOUR ACTUAL KEY if different
            authDomain: "react-c2da8.firebaseapp.com",
            databaseURL: "https://react-c2da8-default-rtdb.firebaseio.com",
            projectId: "react-c2da8",
            storageBucket: "react-c2da8.firebasestorage.app",
            messagingSenderId: "700327720805",
            appId: "1:700327720805:web:bbe2cf35b08d3f5d04538c",
            measurementId: "G-2PKHCWP06M"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);

        // Cloudinary Configuration
        const cloudinaryPreset = "farhadsultan";
        const cloudinaryCloudName = "dbiltdpxh";
        const cloudinaryUploadURL = `https://api.cloudinary.com/v1_1/${cloudinaryCloudName}/image/upload`;

        // DOM Elements
        const landingView = document.getElementById('landingView');
        const authFormsContainer = document.getElementById('authFormsContainer');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const mainAppView = document.getElementById('mainAppView');
        const userProfileImage = document.getElementById('userProfileImage');
        const profileArea = document.getElementById('profileArea');
        const profileEditModal = document.getElementById('profileEditModal');
        const contentSections = document.querySelectorAll('.contentSection');
        const navLinks = document.querySelectorAll('.navLink'); // All nav links (desktop, mobile, modal)
        const hamburgerIcon = document.getElementById('hamburgerIcon');
        const mobileMenu = document.getElementById('mobileMenu');
        const mobileMenuNavClose = document.getElementById('mobileMenuNavClose');

        const homeMusicPlayer = document.getElementById('homeMusicPlayer');
        const playerAlbumArt = document.getElementById('playerAlbumArt');
        const playerSongTitle = document.getElementById('playerSongTitle');
        const playerArtistName = document.getElementById('playerArtistName');
        const playerProgress = document.getElementById('playerProgress');
        const playerProgressBar = document.getElementById('playerProgressBar');
        const playerCurrentTime = document.getElementById('playerCurrentTime');
        const playerTotalTime = document.getElementById('playerTotalTime');
        const prevTrackBtn = document.getElementById('prevTrackBtn');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const nextTrackBtn = document.getElementById('nextTrackBtn');
        const audioPlayer = document.getElementById('audioPlayer');
        const homeMusicList = document.getElementById('homeMusicList');
        const homeNoMusicPrompt = document.getElementById('homeNoMusicPrompt');
        const promptGoToAddMusic = document.getElementById('promptGoToAddMusic');

        // Global state
        let currentUser = null;
        let currentUserData = null;
        let currentPlaylist = []; // For the player
        let currentTrackIndex = 0;
        let allUserSongs = []; // For searching, could be large
        let userPlaylists = {};


        // --- UTILITY FUNCTIONS ---
        function displayMessage(elementId, message, isError = true) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.color = isError ? '#ff4d4d' : '#4CAF50'; // Red for error, green for success
                element.classList.remove('hidden');
                setTimeout(() => element.classList.add('hidden'), 5000);
            }
        }

        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', cloudinaryPreset);

            try {
                const response = await fetch(cloudinaryUploadURL, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.secure_url) {
                    return data.secure_url;
                } else {
                    throw new Error(data.error?.message || 'Cloudinary upload failed');
                }
            } catch (error) {
                console.error("Cloudinary Upload Error:", error);
                throw error;
            }
        }

        async function uploadToFirebaseStorage(file, path) {
            const fileRef = storageRef(storage, path);
            const uploadTask = uploadBytesResumable(fileRef, file);

            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                        // You could update a progress bar UI element here
                    },
                    (error) => {
                        console.error("Firebase Storage Upload Error:", error);
                        reject(error);
                    },
                    async () => {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        resolve(downloadURL);
                    }
                );
            });
        }

        function formatDateForInput(dateString) { // yyyy-mm-dd
            if (!dateString) return '';
            // Assuming dateString is dd/mm/yyyy from DB or needs conversion
            // For now, if it's already yyyy-mm-dd, it's fine.
            // If it's a timestamp or another format, convert it.
            // Firebase typically stores dates as strings or timestamps. Let's assume it's yyyy-mm-dd
            return dateString;
        }
        function formatInputDateForDB(inputDate) { // from yyyy-mm-dd from input
            return inputDate; // Assuming stored as yyyy-mm-dd
        }


        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await fetchCurrentUserData();
                landingView.classList.add('hidden');
                authFormsContainer.classList.remove('visible');
                authFormsContainer.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                showView('homeViewContent'); // Default view
                loadUserPlaylists();
                loadUserMusicForHome();
            } else {
                currentUser = null;
                currentUserData = null;
                mainAppView.classList.add('hidden');
                authFormsContainer.classList.remove('visible');
                authFormsContainer.classList.add('hidden'); // ensure forms are hidden
                landingView.classList.remove('hidden');
                // Clear any sensitive data from UI
                if(userProfileImage) userProfileImage.src = "https://via.placeholder.com/50";
                currentPlaylist = [];
                allUserSongs = [];
                userPlaylists = {};
                if (audioPlayer) audioPlayer.pause();

            }
        });

        document.getElementById('showLoginBtn').addEventListener('click', () => {
            authFormsContainer.classList.add('visible');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
        });

        document.getElementById('showRegisterBtn').addEventListener('click', () => {
            authFormsContainer.classList.add('visible');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        });

        authFormsContainer.addEventListener('click', (e) => { // Close modal if background is clicked
            if (e.target === authFormsContainer) {
                authFormsContainer.classList.remove('visible');
            }
        });

        document.querySelectorAll('.toggleFormLink').forEach(link => {
            link.addEventListener('click', (e) => {
                const targetFormId = e.target.dataset.form;
                if (targetFormId === 'registerForm') {
                    loginForm.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                } else {
                    registerForm.classList.add('hidden');
                    loginForm.classList.remove('hidden');
                }
            });
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state change will handle UI update
                loginForm.reset();
            } catch (error) {
                console.error("Login error:", error);
                displayMessage('loginError', error.message);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = document.getElementById('registerFullName').value;
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const gender = document.getElementById('registerGender').value;
            const dob = document.getElementById('registerDob').value; // yyyy-mm-dd
            const profilePicFile = document.getElementById('registerProfilePic').files[0];

            if (!fullName || !username || !email || !password || !dob) {
                 displayMessage('registerError', "Please fill all required fields.");
                 return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                let profilePictureUrl = "https://via.placeholder.com/150/000000/FFFFFF/?text=User"; // Default
                if (profilePicFile) {
                    profilePictureUrl = await uploadToCloudinary(profilePicFile);
                }

                const userData = {
                    uid: user.uid,
                    fullName,
                    username,
                    email,
                    gender,
                    dob: formatInputDateForDB(dob),
                    profilePictureUrl,
                    joinedAt: serverTimestamp()
                };

                await set(ref(database, `users/${user.uid}`), userData);
                registerForm.reset();
                // Auth state change will handle UI update
            } catch (error) {
                console.error("Registration error:", error);
                displayMessage('registerError', error.message);
            }
        });

        document.getElementById('logoutButton').addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
            }
        });
        document.getElementById('logoutButtonMobile').addEventListener('click', async () => {
            try {
                await signOut(auth);
                 mobileMenu.classList.remove('open'); // Close menu on logout
            } catch (error) {
                console.error("Logout error:", error);
            }
        });


        // --- USER PROFILE ---
        async function fetchCurrentUserData() {
            if (!currentUser) return;
            try {
                const snapshot = await get(child(ref(database), `users/${currentUser.uid}`));
                if (snapshot.exists()) {
                    currentUserData = snapshot.val();
                    userProfileImage.src = currentUserData.profilePictureUrl || "https://via.placeholder.com/50";
                    // Pre-fill profile edit form
                    document.getElementById('editFullName').value = currentUserData.fullName || '';
                    document.getElementById('editUsername').value = currentUserData.username || '';
                    document.getElementById('editGender').value = currentUserData.gender || 'male';
                    document.getElementById('editDob').value = formatDateForInput(currentUserData.dob);
                    document.getElementById('editCurrentProfilePic').src = currentUserData.profilePictureUrl || "https://via.placeholder.com/100";

                } else {
                    console.log("No user data found!");
                }
            } catch (error) {
                console.error("Error fetching user data:", error);
            }
        }

        profileArea.addEventListener('click', () => {
            if (currentUserData) { // Ensure data is loaded
                 // Re-fetch fresh data or ensure form is up-to-date if it could change elsewhere
                document.getElementById('editFullName').value = currentUserData.fullName || '';
                document.getElementById('editUsername').value = currentUserData.username || '';
                document.getElementById('editGender').value = currentUserData.gender || 'male';
                document.getElementById('editDob').value = formatDateForInput(currentUserData.dob);
                document.getElementById('editCurrentProfilePic').src = currentUserData.profilePictureUrl || "https://via.placeholder.com/100";
                profileEditModal.classList.add('visible');
            }
        });

        document.getElementById('cancelProfileEdit').addEventListener('click', () => {
            profileEditModal.classList.remove('visible');
        });

        document.getElementById('profileEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const updatedData = {
                fullName: document.getElementById('editFullName').value,
                username: document.getElementById('editUsername').value,
                gender: document.getElementById('editGender').value,
                dob: formatInputDateForDB(document.getElementById('editDob').value),
            };

            const newProfilePicFile = document.getElementById('editProfilePicFile').files[0];

            try {
                if (newProfilePicFile) {
                    displayMessage('profileEditMessage', 'Uploading new picture...', false);
                    updatedData.profilePictureUrl = await uploadToCloudinary(newProfilePicFile);
                }

                await update(ref(database, `users/${currentUser.uid}`), updatedData);
                await fetchCurrentUserData(); // Refresh data
                displayMessage('profileEditMessage', 'Profile updated successfully!', false);
                setTimeout(() => {
                    profileEditModal.classList.remove('visible');
                    document.getElementById('editProfilePicFile').value = ''; // Clear file input
                }, 1500);
            } catch (error) {
                console.error("Profile update error:", error);
                displayMessage('profileEditMessage', error.message);
            }
        });


        // --- NAVIGATION & VIEW MANAGEMENT ---
        function showView(viewId) {
            contentSections.forEach(section => section.classList.add('hidden'));
            const activeSection = document.getElementById(viewId);
            if (activeSection) activeSection.classList.remove('hidden');

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.view === viewId) {
                    link.classList.add('active');
                }
            });
            // Specific actions for views
            if (viewId === 'homeViewContent') loadUserMusicForHome();
            if (viewId === 'playlistsViewContent') {
                loadUserPlaylists();
                document.getElementById('playlistSongsView').classList.add('hidden'); // Hide song list
                document.getElementById('playlistGrid').classList.remove('hidden'); // Show playlist grid
                document.getElementById('showCreatePlaylistBtn').classList.remove('hidden');
            }
            if (viewId === 'musicAddViewContent') populatePlaylistDropdown('addSongPlaylist');

        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const viewId = e.target.closest('.navLink').dataset.view;
                if (viewId) {
                    showView(viewId);
                    if(mobileMenu.classList.contains('open')) mobileMenu.classList.remove('open'); // Close mobile menu if open
                }
            });
        });

        hamburgerIcon.addEventListener('click', () => {
            mobileMenu.classList.toggle('open');
        });
        mobileMenuNavClose.addEventListener('click', () => {
            mobileMenu.classList.remove('open');
        });
        // Close mobile menu if clicking outside of it (optional)
        document.addEventListener('click', (e) => {
            if (mobileMenu.classList.contains('open') && !mobileMenu.contains(e.target) && !hamburgerIcon.contains(e.target)) {
                mobileMenu.classList.remove('open');
            }
        });


        // --- MUSIC PLAYER ---
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        audioPlayer.addEventListener('loadedmetadata', () => {
            playerTotalTime.textContent = formatTime(audioPlayer.duration);
        });

        audioPlayer.addEventListener('timeupdate', () => {
            playerCurrentTime.textContent = formatTime(audioPlayer.currentTime);
            const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            playerProgressBar.style.width = `${progressPercent}%`;
        });

        audioPlayer.addEventListener('ended', () => {
            playNextTrack();
        });

        playPauseBtn.addEventListener('click', () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                audioPlayer.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        });

        prevTrackBtn.addEventListener('click', () => {
            if (currentPlaylist.length > 0) {
                currentTrackIndex = (currentTrackIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
                loadTrack(currentTrackIndex);
            }
        });

        nextTrackBtn.addEventListener('click', playNextTrack);

        function playNextTrack() {
             if (currentPlaylist.length > 0) {
                currentTrackIndex = (currentTrackIndex + 1) % currentPlaylist.length;
                loadTrack(currentTrackIndex);
            }
        }

        playerProgress.addEventListener('click', (e) => {
            if (audioPlayer.duration) {
                const progressWidth = playerProgress.clientWidth;
                const clickX = e.offsetX;
                audioPlayer.currentTime = (clickX / progressWidth) * audioPlayer.duration;
            }
        });

        function loadTrack(index, playImmediately = true) {
            if (!currentPlaylist || index < 0 || index >= currentPlaylist.length) {
                console.log("Track index out of bounds or no playlist.");
                // Optionally stop player or show message
                homeMusicPlayer.classList.add('hidden'); // Hide player if no track
                return;
            }
            homeMusicPlayer.classList.remove('hidden');

            const track = currentPlaylist[index];
            playerAlbumArt.src = track.albumArtUrl || 'https://via.placeholder.com/300';
            playerSongTitle.textContent = track.title;
            playerArtistName.textContent = track.artistName || 'Unknown Artist';
            audioPlayer.src = track.audioUrl;

            if (playImmediately) {
                audioPlayer.play()
                    .then(() => playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>')
                    .catch(error => {
                        console.error("Error playing audio:", error);
                        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                        // Display error to user potentially
                    });
            } else {
                 playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        }

        function playSongFromList(songId) {
            // Find the song in allUserSongs or currently displayed list
            const song = allUserSongs.find(s => s.id === songId);
            if (song) {
                // For simplicity, clicking a song from a list makes it the current "playlist" of one.
                // Or, if it's part of a displayed playlist (e.g., from Playlists view), set that as currentPlaylist.
                // For now, treat as a single song play.
                currentPlaylist = [song];
                currentTrackIndex = 0;
                loadTrack(currentTrackIndex);
            }
        }


        // --- MUSIC MANAGEMENT (HOME, ADD, PLAYLISTS) ---
        async function loadUserMusicForHome() {
            if (!currentUser) return;
            const songsRef = ref(database, 'songs');
            onValue(songsRef, (snapshot) => { // Listen for real-time updates
                allUserSongs = []; // Reset for fresh load
                homeMusicList.innerHTML = ''; // Clear current list
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const song = { id: childSnapshot.key, ...childSnapshot.val() };
                        // For now, "Home" shows all songs uploaded by the current user.
                        // The brief mentioned "register olan herkeste olan muzikleri aratmak olacak" for search
                        // but "Homede eger listede muzik yoksa" implies user's own music focus for home.
                        // I'll list songs by current user on home.
                        if (song.uploaderUid === currentUser.uid) {
                           allUserSongs.push(song);
                        }
                    });

                    if (allUserSongs.length > 0) {
                        homeNoMusicPrompt.classList.add('hidden');
                        allUserSongs.forEach(song => renderSongItem(song, homeMusicList));
                        // Optionally set the first song for the player if no song is playing
                        if (audioPlayer.paused && !audioPlayer.src && allUserSongs.length > 0) {
                            currentPlaylist = [...allUserSongs]; // Set home list as current playlist
                            currentTrackIndex = 0;
                            loadTrack(currentTrackIndex, false); // Load first track but don't auto-play
                        }
                    } else {
                        homeNoMusicPrompt.classList.remove('hidden');
                        homeMusicPlayer.classList.add('hidden'); // Hide player if no music
                    }
                } else {
                    homeNoMusicPrompt.classList.remove('hidden');
                    homeMusicPlayer.classList.add('hidden');
                }
                // Also refresh all songs list used for search
                fetchAllSongsForSearch(); // If search is across all users
            });
        }

        function renderSongItem(song, containerElement) {
            const item = document.createElement('div');
            item.classList.add('musicListItem');
            item.dataset.songId = song.id;
            item.innerHTML = `
                <img src="${song.albumArtUrl || 'https://via.placeholder.com/150'}" alt="${song.title}">
                <div class="musicListItemTitle">${song.title}</div>
                <div class="musicListItemArtist">${song.artistName || 'Unknown Artist'}</div>
            `;
            item.addEventListener('click', () => playSongFromList(song.id));
            containerElement.appendChild(item);
        }

        promptGoToAddMusic.addEventListener('click', () => showView('musicAddViewContent'));


        // Music Add Form
        const musicAddForm = document.getElementById('musicAddForm');
        musicAddForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                displayMessage('musicAddMessage', "You must be logged in to add music.");
                return;
            }

            const title = document.getElementById('addSongTitle').value;
            const artistName = document.getElementById('addArtistName').value;
            const albumArtFile = document.getElementById('addAlbumArt').files[0];
            const musicFile = document.getElementById('addMusicFile').files[0];
            const selectedPlaylistId = document.getElementById('addSongPlaylist').value;

            if (!title || !albumArtFile || !musicFile) {
                displayMessage('musicAddMessage', "Title, Album Art, and Music File are required.");
                return;
            }
            if (!selectedPlaylistId) {
                 displayMessage('musicAddMessage', "Please select or create a playlist.");
                return;
            }

            displayMessage('musicAddMessage', "Uploading... Please wait.", false);

            try {
                const albumArtUrl = await uploadToCloudinary(albumArtFile);
                const audioUrl = await uploadToFirebaseStorage(musicFile, `music/${currentUser.uid}/${Date.now()}_${musicFile.name}`);

                const songsListRef = ref(database, 'songs');
                const newSongRef = push(songsListRef); // Generate a new unique key for the song

                const songData = {
                    title,
                    artistName,
                    albumArtUrl,
                    audioUrl,
                    uploaderUid: currentUser.uid,
                    uploaderName: currentUserData?.username || currentUser.email,
                    createdAt: serverTimestamp(),
                    // playlistId: selectedPlaylistId // Store initial playlist
                };

                await set(newSongRef, songData);
                const songId = newSongRef.key;

                // Add song to the selected playlist
                const playlistSongsRef = ref(database, `playlists/${selectedPlaylistId}/songs/${songId}`);
                await set(playlistSongsRef, true); // Using true as value to mark song presence

                // Also update a list of playlists the song belongs to, in the song itself (optional, for easier querying)
                const songPlaylistsRef = ref(database, `songs/${songId}/playlistIds/${selectedPlaylistId}`);
                await set(songPlaylistsRef, true);


                displayMessage('musicAddMessage', "Music added successfully!", false);
                musicAddForm.reset();
                showView('homeViewContent'); // Go to home to see the new music
            } catch (error) {
                console.error("Error adding music:", error);
                displayMessage('musicAddMessage', `Error: ${error.message}`);
            }
        });

        // Playlists
        const createPlaylistForm = document.getElementById('createPlaylistForm');
        const showCreatePlaylistBtn = document.getElementById('showCreatePlaylistBtn');
        const cancelCreatePlaylistBtn = document.getElementById('cancelCreatePlaylistBtn');
        const newPlaylistNameInput = document.getElementById('newPlaylistName');
        const playlistGrid = document.getElementById('playlistGrid');
        const noPlaylistsPrompt = document.getElementById('noPlaylistsPrompt');
        const addSongPlaylistSelect = document.getElementById('addSongPlaylist');
        const showCreatePlaylistFromMusicAdd = document.getElementById('showCreatePlaylistFromMusicAdd');

        const playlistSongsView = document.getElementById('playlistSongsView');
        const playlistSongsTitle = document.getElementById('playlistSongsTitle');
        const backToPlaylistsBtn = document.getElementById('backToPlaylistsBtn');
        const playlistSongsList = document.getElementById('playlistSongsList');


        showCreatePlaylistBtn.addEventListener('click', () => {
            createPlaylistForm.classList.remove('hidden');
            showCreatePlaylistBtn.classList.add('hidden');
        });
         showCreatePlaylistFromMusicAdd.addEventListener('click', () => {
            // This button is on the "Add Music" page. We need a way to create a playlist
            // and then select it, or handle this flow more smoothly.
            // For now, let's just prompt:
            const playlistName = prompt("Enter new playlist name:");
            if (playlistName && playlistName.trim() !== "" && currentUser) {
                handleCreatePlaylist(playlistName.trim(), (newPlaylistId) => {
                    // Automatically select the new playlist in the dropdown
                    populatePlaylistDropdown('addSongPlaylist', newPlaylistId);
                });
            }
        });

        cancelCreatePlaylistBtn.addEventListener('click', () => {
            createPlaylistForm.classList.add('hidden');
            showCreatePlaylistBtn.classList.remove('hidden');
            newPlaylistNameInput.value = '';
        });

        createPlaylistForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const playlistName = newPlaylistNameInput.value.trim();
            if (!playlistName || !currentUser) return;
            handleCreatePlaylist(playlistName);
        });

        async function handleCreatePlaylist(playlistName, callbackOnSuccess) {
            try {
                const playlistsRef = ref(database, 'playlists');
                const newPlaylistRef = push(playlistsRef);
                const playlistData = {
                    name: playlistName,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    songs: {} // To store song IDs
                };
                await set(newPlaylistRef, playlistData);
                newPlaylistNameInput.value = '';
                createPlaylistForm.classList.add('hidden');
                showCreatePlaylistBtn.classList.remove('hidden');
                displayMessage('playlistFormMessage', 'Playlist created!', false);
                if (callbackOnSuccess) callbackOnSuccess(newPlaylistRef.key);
                // loadUserPlaylists() will be called by onValue listener automatically
            } catch (error) {
                console.error("Error creating playlist:", error);
                displayMessage('playlistFormMessage', `Error: ${error.message}`);
            }
        }

        function loadUserPlaylists() {
            if (!currentUser) return;
            const userPlaylistsRef = ref(database, 'playlists');
            // Query for playlists by current user: orderByChild('userId').equalTo(currentUser.uid)
            // For simplicity and if rules allow, get all and filter, or structure better.
            // Let's assume we filter by userId if data isn't too large or structure is /user-playlists/{userId}/{playlistId}
            // For now, listening to all 'playlists' and filtering client-side or assuming all playlists are user's.
            // A better structure: `user-playlists/${currentUser.uid}`
            // Using current structure, filtering client-side for demo:

            onValue(userPlaylistsRef, (snapshot) => {
                playlistGrid.innerHTML = '';
                userPlaylists = {}; // Reset
                let hasPlaylists = false;
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const playlist = { id: childSnapshot.key, ...childSnapshot.val() };
                        if (playlist.userId === currentUser.uid) { // Filter for current user
                            userPlaylists[playlist.id] = playlist;
                            renderPlaylistItem(playlist);
                            hasPlaylists = true;
                        }
                    });
                }
                noPlaylistsPrompt.classList.toggle('hidden', hasPlaylists);
                populatePlaylistDropdown('addSongPlaylist');

                // Create a default "Library" playlist if none exist and user has songs without a playlist
                // (This logic is complex; for now, user must create or pick one during upload)
                // Simpler: if no playlists at all, guide them to create one.
                if (!hasPlaylists && addSongPlaylistSelect.options.length === 0) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Create a playlist first";
                    option.disabled = true;
                    addSongPlaylistSelect.innerHTML = ''; // Clear
                    addSongPlaylistSelect.appendChild(option);
                } else if (addSongPlaylistSelect.options.length > 0 && addSongPlaylistSelect.options[0].disabled) {
                    // If "Create playlist first" was there, remove it now that playlists exist
                    populatePlaylistDropdown('addSongPlaylist');
                }


            });
        }

        function renderPlaylistItem(playlist) {
            const item = document.createElement('div');
            item.classList.add('playlistItem');
            item.dataset.playlistId = playlist.id;
            item.innerHTML = `
                <i class="fas fa-music"></i> <h4>${playlist.name}</h4>
                <p>${Object.keys(playlist.songs || {}).length} songs</p>
            `;
            item.addEventListener('click', () => showSongsForPlaylist(playlist.id));
            playlistGrid.appendChild(item);
        }

        function populatePlaylistDropdown(selectElementId, selectedId = null) {
            const select = document.getElementById(selectElementId);
            if (!select) return;
            select.innerHTML = ''; // Clear existing options

            const userOwnedPlaylists = Object.values(userPlaylists).filter(p => p.userId === currentUser?.uid);

            if (userOwnedPlaylists.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "No playlists available. Create one.";
                option.disabled = true;
                select.appendChild(option);
                // Disable the actual "Add Music" submit button if no playlist can be chosen.
                const musicAddSubmitButton = musicAddForm.querySelector('button[type="submit"]');
                if(musicAddSubmitButton) musicAddSubmitButton.disabled = true;
                return;
            } else {
                 const musicAddSubmitButton = musicAddForm.querySelector('button[type="submit"]');
                 if(musicAddSubmitButton) musicAddSubmitButton.disabled = false;
            }


            userOwnedPlaylists.forEach(playlist => {
                const option = document.createElement('option');
                option.value = playlist.id;
                option.textContent = playlist.name;
                if (playlist.id === selectedId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
             // Create a default "Library" if it's truly the first time and no playlists exist AND music is being added.
            // This is tricky. User should explicitly create.
            // For "Music Add m ( hangi playliste eklemek istedigide secilsin eger yokda defaulttan bir library acsin otomatik olarak muzik eklendiginde"
            // If no playlists, and music add is attempted, auto-create "Library".
            if (userOwnedPlaylists.length === 0 && selectElementId === 'addSongPlaylist' && !document.getElementById('addSongPlaylist').value) {
                 // This condition is hard to hit now with the disabled state.
                 // Let's assume if selectedPlaylistId is not found and it's required, the form validation will catch it.
                 // The "create new playlist" button is a better approach.
            }
        }

        async function showSongsForPlaylist(playlistId) {
            const playlist = userPlaylists[playlistId];
            if (!playlist) return;

            playlistSongsTitle.textContent = `Songs in "${playlist.name}"`;
            playlistSongsList.innerHTML = ''; // Clear previous songs

            const songIds = Object.keys(playlist.songs || {});
            if (songIds.length === 0) {
                playlistSongsList.innerHTML = '<p>This playlist is empty.</p>';
            } else {
                const songsToLoad = [];
                for (const songId of songIds) {
                    const songSnapshot = await get(child(ref(database), `songs/${songId}`));
                    if (songSnapshot.exists()) {
                        const songData = { id: songSnapshot.key, ...songSnapshot.val() };
                        songsToLoad.push(songData);
                        renderSongItem(songData, playlistSongsList);
                    }
                }
                // Set this playlist for the player
                currentPlaylist = songsToLoad;
                currentTrackIndex = 0;
                if (currentPlaylist.length > 0) {
                    loadTrack(currentTrackIndex, false); // Load first track, don't autoplay
                } else {
                    homeMusicPlayer.classList.add('hidden');
                }
            }

            // Hide playlist grid, show song list for this playlist
            document.getElementById('playlistGrid').classList.add('hidden');
            document.getElementById('showCreatePlaylistBtn').classList.add('hidden');
            createPlaylistForm.classList.add('hidden');
            playlistSongsView.classList.remove('hidden');
        }

        backToPlaylistsBtn.addEventListener('click', () => {
            playlistSongsView.classList.add('hidden');
            document.getElementById('playlistGrid').classList.remove('hidden');
            document.getElementById('showCreatePlaylistBtn').classList.remove('hidden');
            loadUserPlaylists(); // Refresh playlist grid (e.g., song counts)
        });



        // --- SEARCH ---
        const searchInput = document.getElementById('searchInput');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        const noSearchResults = document.getElementById('noSearchResults');
        let allSongsForSearchList = []; // Stores all songs from all users

        async function fetchAllSongsForSearch() {
            // This fetches ALL songs. For large DBs, this is not scalable.
            // Consider Firebase functions + specialized search (Algolia, Typesense) or carefully structured queries.
            const songsRef = ref(database, 'songs');
            const snapshot = await get(songsRef);
            allSongsForSearchList = [];
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    allSongsForSearchList.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
            }
        }

        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            searchResultsContainer.innerHTML = '';

            if (!searchTerm) {
                noSearchResults.classList.add('hidden');
                return;
            }

            const results = allSongsForSearchList.filter(song =>
                song.title?.toLowerCase().includes(searchTerm) ||
                song.artistName?.toLowerCase().includes(searchTerm) ||
                song.uploaderName?.toLowerCase().includes(searchTerm)
            );

            if (results.length > 0) {
                results.forEach(song => renderSongItem(song, searchResultsContainer));
                noSearchResults.classList.add('hidden');
            } else {
                noSearchResults.classList.remove('hidden');
            }
        });


        // --- INITIAL LOAD ---
        // Call functions that need to run on script load after auth state is determined
        // e.g. fetchAllSongsForSearch() can be called once after login, or periodically


        // Make sure everything is set up once DOM is fully loaded (though module script defers by default)
        // document.addEventListener('DOMContentLoaded', () => { /* already handled by script type=module */ });

    </script>

</body>
</html>
